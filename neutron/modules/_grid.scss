/* Grid
---------------------------------------------*/

//Declares the container element of child rows or columns
@mixin columns(
	$columns:"", 
	$container-width:$container-max-width, 
	$container-align:"",
	$padding:$global-column-padding,
	$flush-padding:false,
	$margin:"",
	$flush-margin:true,
	$target:"*"
) {
	max-width: $container-width;
	margin-left: auto;
	margin-right: auto;
	@include clear-fix();

	$column-sum: get-column-sum($columns);	
	$column-count: get-column-count($columns);

	$target-child-selector: "nth-of-type";
	@if $target == "" or $target == "*" {
		$target: "*";
		$target-child-selector: "nth-child";
	}

	//set combined margins accounting for flush margin and deterine available width
	$total-margin-subtraction: 0;
	$available-width:100%;
	
	$extracted-margin-left:"";
	
	@if $margin != "" {
		
	$extracted-margin-left: extract-position($margin,left);
	$extracted-margin-right: extract-position($margin,right);

		$first-margin-value: extract-position($margin,left);
		@if unit($extracted-margin-left) == "%" or unit($extracted-margin-right) == "%" {
			
			//margin is a %
			@if $flush-margin == true {
				$available-width: $available-width - $extracted-margin-left - $extracted-margin-right;
			} @else {
				$available-width: $available-width - (($column-count * $extracted-margin-left) + ($column-count * $extracted-margin-right) );
			}				
		} @else {
			//if non-percent unit used
			$total-margin-subtraction: ($extracted-margin-left + $extracted-margin-right) - (($extracted-margin-left + $extracted-margin-right) / $column-count);
			
			@if $flush-margin == false {
				$total-margin-subtraction: ($extracted-margin-left + $extracted-margin-right);
			}
		}
	}

	//If argument is not a list, 
	//and is not empty, set equal 
	//width to all immediate child elements
	@if type-of($columns) != list and $columns != "" {
		& > #{$target} {
			
			$calculated-width: ($available-width / $columns);
			
			@if $margin != "" and unit($extracted-margin-left) != "%" {
				width: calc(#{$calculated-width} - #{$total-margin-subtraction});
			} @else {
				width: $calculated-width;
			} 
					
			float:left;
			padding: $padding;				
							
			@if $margin != "" {
				margin: $margin;
			}
			
			@content;
		}
	}

	//If argument is a list, set 
	//width of each immediate child 
	//as instructed by passed list
	@if type-of($columns) == list {
		$index: 0;

		@each $column in $columns {	
			$index: $index + 1;

			& > #{$target}:#{$target-child-selector}(#{$column-count}n+#{$index}) {
				
				$calculated-width: ($available-width / $column-sum) * $column;
				
				@if $margin != "" and unit($extracted-margin-left) != "%" {
					width: calc(#{$calculated-width} - #{$total-margin-subtraction});
				} @else {
					width: $calculated-width;
				}
				
				float:left;
				padding: $padding;				

				@if $margin != "" {
					margin: $margin;
				}
				
				@content;
			}
		}
	}
	
	@if $columns != "" {
		//apply styles to first column of the row
		@include target-col(1, $column-count, $target) {
			clear: left;
			
			@if $flush-padding {
				padding-left: 0;
			}
			@if $flush-margin {
				margin-left: 0;
			}
		}
	
		//apply styles to last column of the row
		@include target-col($column-count, $column-count, $target) {
				
			@if $flush-padding {
				padding-right: 0;
			}
			@if $flush-margin {
				margin-right: 0;
			}
		}
	}

	//Set alignment of container
	@if $container-align != "" {
		@include container-align($container-align);
	}

}

//Alias for columns
@mixin column(
	$columns:"", 
	$container-width:$container-max-width, 
	$container-align:"",
	$padding:$global-column-padding,
	$margin:"",
	$target:"*"
) {
	@include columns(
		$columns,
		$container-width,
		$container-align,
		$padding,
		$margin,
		$target
	);
}

@mixin target-col($column-target, $column-count, $target-selector:"*") {

	$target-child-selector: child-selector($target-selector);

	& > #{$target-selector} {
		&:#{$target-child-selector}(#{$column-count}n+#{$column-target}) {
			@content;
		}
	}
}

@mixin container-align($align:"") {
	//Set alignment 
	@if $align != "" {
		float:none;
		
		@if $align == left {
			margin-left: 0;
		}
		
		@if $align == right {
			margin-right: 0;
		}
		
		@if $align == center {
			margin-right: auto;
			margin-left: auto;
		}

	}
}

@function get-column-sum($columns) {
	@if type-of($columns) == list {
		@return sum($columns);
	} @else {
		@return $columns;
	}
}

@function get-column-count($columns) {
	@if type-of($columns) == list {
		@return length($columns);
	} @else {
		@return $columns;
	}
}

@function child-selector($target-selector) {
	$child-selector: "nth-of-type";
	
	@if $target-selector == "*" {
		$child-selector: "nth-child";
	}
	
	@return $child-selector;
}

@function calculate-widths($columns) {
	$column-total: sum($columns);
	$calculated-widths:();

	$index: 0;
	@each $column in $columns {	
		$index: $index + 1;
		$width: (100% / $column-total) * $column;
		$calculated-widths: append($calculated-widths, $width, comma);
	}

	@return $calculated-widths;
}

@mixin order($order, $columns:"") {
	
	@if type-of($order) == list {
		//if no ratio is set, determine 
		//ratio from provided order list
		@if $columns == "" {
			$columns:();
			$order-count: length($order);

			@for $i from 1 through $order-count {
				$columns: append($columns, 1, comma);
			}

		}

		//calculate widths of 
		//current and new layouts
		$column-count: length($columns);
		$new-columns:();
		@each $index in $order {
			$item: nth($columns, $index);
			$new-columns:append($new-columns, $item);
		}

		$original-widths:calculate-widths($columns);
		$new-widths:calculate-widths($new-columns);
	
		//iterate through each column
		$index: 0;
		@each $column in $order {
			$index: $index + 1;

			//calc sum of original previous widths
			$orig-w-before: 0;
			@for $i from 1 through $column {
				$orig-w-before: $orig-w-before + nth($original-widths, $i);
			} 
			$orig-w-before: $orig-w-before - nth($original-widths, $column);
	 
			//calc sum of new previous widths
			$new-w-before: 0;
			@for $i from 1 through $index {
				$new-w-before: $new-w-before + nth($new-widths, $i);
			} 
			$new-w-before: $new-w-before - nth($new-widths, $index);
			
			//calc sum of original following widths
			$orig-w-after: 100;
			@for $i from 1 through $column {
				$orig-w-after: $orig-w-after - nth($original-widths, $i);
			} 
	
			//calc sum of new following widths
			$new-w-after: 100;
			@for $i from 1 through $index {
				$new-w-after: $new-w-after - nth($new-widths, $i);
			}
						
			$left: $new-w-before - $orig-w-before;
			$right: $new-w-after - $orig-w-after;

			@if $index > $column or $column == $index {
				//if new position is after current one, pull 
				& > *:nth-child(#{$column}) {
					left: $left;
					position: relative;
				}

			}
			
			@if $index < $column {
				//if new position is before current one, pull 
				& > *:nth-child(#{$column}) {
					right: $right;
					position: relative;
				}
				
			} 
		}
	}
}
